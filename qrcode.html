<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de QR Code - Virtual Pass</title>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <style>
        /* Resetando margens e preenchimentos */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Corpo da página */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #1e1e1e;
            color: white;
            min-height: 100vh;
        }

        /* Cabeçalho */
        header {
            background-color: #004d40;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        header .logo img {
            width: 150px;
        }

        header nav a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
            font-weight: bold;
            transition: color 0.3s;
        }

        header nav a:hover {
            color: #b2dfdb;
        }

        /* Main com espaçamento dinâmico para o cabeçalho */
        main {
            padding-top: calc(100px + 20px);
            text-align: center;
        }

        /* Estilo para a seção do leitor de QR Code */
        #qr-reader {
            margin: 20px auto;
            width: 100%;
            max-width: 400px;
            height: 400px;
            border: 2px solid #ccc;
            border-radius: 8px;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        footer {
            text-align: center;
            padding: 10px;
            background-color: #004d40;
            color: white;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        .message {
            text-align: center;
            font-size: 18px;
            margin-top: 20px;
        }

    </style>
</head>
<body>
    <!-- Cabeçalho global -->
    <header>
        <div class="logo">
            <img src="https://portal.ifto.edu.br/imagens/identidade-visual/marca-ifto-assinatura-1-branco.png" alt="Logo IFTO">
        </div>
        <nav>
            <a href="Inicio.html" id="link-home">Home</a>
            <a href="Passes.html" id="link-passes">Passes</a>
            <a href="Carrinho.html" id="link-carrinho">Carrinho</a>
            <a href="Perfil.html" id="link-perfil">Perfil</a>
            <a href="Login.html" id="link-login">Login</a>
            <a href="QRCode.html" id="link-qrcode">QR Code</a> <!-- Novo link adicionado -->
        </nav>
    </header>

    <main>
        <h1>Leitor de QR Code</h1>
        <div id="qr-reader"></div>
        <button id="start-scan">Iniciar Leitura do QR Code</button>
        <div class="message" id="status-message"></div>
    </main>

    <footer>
        <p>Todos os direitos reservados - 2024</p>
    </footer>

    <script>
        // Função para iniciar o scanner de QR Code
        function startQRScanner() {
            const qrCodeScanner = new Html5Qrcode("qr-reader");

            qrCodeScanner.start(
                { facingMode: "environment" }, // Usa a câmera traseira
                {
                    fps: 10, // Frames por segundo
                    qrbox: 250, // Caixa de leitura do QR Code
                },
                (decodedText) => {
                    // Callback quando um QR Code é lido com sucesso
                    console.log("QR Code decodificado:", decodedText);
                    document.getElementById("status-message").innerText = "QR Code lido com sucesso!";
                    validatePass(decodedText); // Envia o QR Code para validação
                },
                (errorMessage) => {
                    console.error("Erro ao ler o QR Code:", errorMessage);
                    document.getElementById("status-message").innerText = "Falha ao ler o QR Code.";
                }
            ).catch((err) => console.error("Erro ao iniciar scanner:", err));
        }

        // Função para enviar os dados do QR Code ao ESP32 para validação
        function validatePass(qrCodeData) {
            fetch("http://192.168.4.1/validate", {  // Endereço do servidor ESP32
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ qrCode: qrCodeData }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Passe validado com sucesso!");
                } else {
                    alert("Falha na validação: " + data.message);
                }
            })
            .catch(err => console.error("Erro na validação:", err));
        }

        // Ativar scanner ao clicar no botão
        document.getElementById("start-scan").addEventListener("click", startQRScanner);
    </script>
</body>
</html>
